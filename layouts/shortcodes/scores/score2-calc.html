<script>
  // Sliders
  // TODO: rounding issues, limit input, g/L
  window.addEventListener("load", () => {
    // Age
    $(function () {
      const Slider = $("#ageSlider");
      const Input = $("#age");
      const min = 40;
      const max = 89;
      Slider.ionRangeSlider({
        skin: "material",
        min: min,
        max: max,
        postfix: " ans",
        extra_classes: "flex-fill",
      });
      let sliderInstance = Slider.data("ionRangeSlider");
      Input.on("input", function () {
        let val = this.value;
        // Validate Slider
        if (val < min) {
          val = min;
        } else if (val > max) {
          val = max;
        }
        sliderInstance.update({ from: val });
      });
    });
    // SBP
    $(function () {
      const Slider = $("#sbpSlider");
      const Input = $("#sbp");
      const min = 100;
      const max = 200;
      Slider.ionRangeSlider({
        skin: "material",
        min: min,
        max: max,
        postfix: " mmHg",
        extra_classes: "flex-fill",
      });
      let sliderInstance = Slider.data("ionRangeSlider");
      Input.on("input", function () {
        let val = this.value;
        // Validate Slider
        if (val < min) {
          val = min;
        } else if (val > max) {
          val = max;
        }
        sliderInstance.update({ from: val });
      });
    });
    // Cht
    $(function () {
      const Slider = $("#chtSlider");
      const Input = $("#cht");
      const min = 3;
      const max = 9;
      Slider.ionRangeSlider({
        skin: "material",
        min: min,
        max: max,
        step: 0.1,
        postfix: " mmol/L",
        extra_classes: "flex-fill",
      });
      let sliderInstance = Slider.data("ionRangeSlider");
      Input.on("input", function () {
        let val = this.value;
        // Validate Slider
        if (val < min) {
          val = min;
        } else if (val > max) {
          val = max;
        }
        sliderInstance.update({ from: val });
      });
    });
    // HDL
    $(function () {
      const Slider = $("#hdlSlider");
      const Input = $("#hdl");
      const min = 0.7;
      const max = 2.5;
      Slider.ionRangeSlider({
        skin: "material",
        min: min,
        max: max,
        step: 0.1,
        postfix: " mmol/L",
        extra_classes: "flex-fill",
      });
      let sliderInstance = Slider.data("ionRangeSlider");
      Input.on("input", function () {
        let val = this.value;
        // Validate Slider
        if (val < min) {
          val = min;
        } else if (val > max) {
          val = max;
        }
        sliderInstance.update({ from: val });
      });
    });
  });
</script>
<script>
  // Ce script implémente le calcul du risque cardiovasculaire selon l'algorithme SCORE2
  // pour les régions à faible risque.
  // Source: SCORE2 risk prediction algorithms, ESC European Heart Journal, 2021.

  document.addEventListener("DOMContentLoaded", function () {
    const calculateBtn = document.getElementById("calculate-btn");
    const form = document.getElementById("score-form");
    const resultSection = document.getElementById("result-section");
    const resultDisplay = document.getElementById("result-display");
    const riskScoreEl = document.getElementById("risk-score");
    const riskCategoryEl = document.getElementById("risk-category");
    const riskDescriptionEl = document.getElementById("risk-description");
    const errorSection = document.getElementById("error-section");
    const errorMessageEl = document.getElementById("error-message");

    calculateBtn.addEventListener("click", calculateScore);

    function calculateScore() {
      // Masquer les anciens résultats et erreurs
      resultSection.classList.add("d-none");
      errorSection.classList.add("d-none");

      // Récupérer les valeurs du formulaire
      // LDL-C = TC - HDL-C - (TG/2.2) in mmol/L
      const gender = form.elements["gender"].value;
      const age = parseFloat(form.elements["age"].value);
      const isSmoker = parseInt(form.elements["smoker"].value);
      const sbp = parseInt(form.elements["sbp"].value);
      const tchol = parseFloat(form.elements["cht"].value);
      const thdl = parseFloat(form.elements["hdl"].value);

      // Coefficients SCORE2 pour les pays à faible risque (ex: France)
    let coeffs;

    if (age < 70) {
      coeffs = {
      female: {
        age: 0.4648,
        smoker: 0.7744,
        sbp: 0.3131,
        tchol: 0.1002,
        thdl: -0.2606,
        smoker_age: -0.1088,
        sbp_age: -0.0277,
        tchol_age: -0.0226,
        thdl_age: 0.0613,
        basesurv: 0.9776,
        scale1: -0.738,
        scale2: 0.7019,
      },
      male: {
        age: 0.3742,
        smoker: 0.6012,
        sbp: 0.2777,
        tchol: 0.1458,
        thdl: -0.2698,
        smoker_age: -0.0755,
        sbp_age: -0.0255,
        tchol_age: -0.0281,
        thdl_age: 0.0426,
        basesurv: 0.9605,
        scale1: -0.5699,
        scale2: 0.7476,
      }
    }
    } else {
      // SCORE2-OP
        coeffs = {
          female: {
            age: 0.0789,
            smoker: 0.4921,
            sbp: 0.0102,
            tchol: 0.0605,
            thdl: -0.304,
            smoker_age: -0.0255,
            sbp_age: -0.0004,
            tchol_age: -0.0009,
            thdl_age: 0.0154,
            basesurv: 0.8082,
            meanLP: 0.229,
            scale1: -0.85,
            scale2: 0.82,
          },
          male: {
            age: 0.0634,
            smoker: 0.3524,
            sbp: 0.0094,
            tchol: 0.085,
            thdl: -0.3564,
            smoker_age: -0.0247,
            sbp_age: -0.0005,
            tchol_age: -0.0073,
            thdl_age: 0.0091,
            basesurv: 0.7576,
            meanLP: 0.093,
            scale1: -0.61,
            scale2: 0.89,
          },
        };
      }

      let c = coeffs[gender];
      let cage;
      let csbp;
      let ctchol;
      let cthdl;
      let csmoker_age;
      let csbp_age;
      let ctchol_age;
      let cthdl_age;

      // Calcul du prédicteur linéaire (LP)
      if (age < 70) {
        cage = (age - 60) / 5;
        csbp = (sbp - 120) / 20;
        ctchol = tchol - 6;
        cthdl = (thdl - 1.3) / 0.5;
        csmoker_age = cage * isSmoker;
        csbp_age = cage * csbp;
        ctchol_age = cage * ctchol;
        cthdl_age = cage * cthdl;
      } else {
        cage = age - 73;
        csbp = sbp - 150;
        ctchol = tchol - 6;
        cthdl = thdl - 1.4;
        csmoker_age = cage * isSmoker;
        csbp_age = cage * csbp;
        ctchol_age = cage * ctchol;
        cthdl_age = cage * cthdl;
      }

      let ctchol_calc = ctchol * c.tchol;
      let ctchol_rounded = ctchol_calc;
      let cthdl_calc = cthdl * c.thdl;
      let cthdl_rounded = cthdl_calc;

      console.log("cage: " + cage);
      console.log("Age (per year) c.age: " + c.age);
      console.log("Age calc: " + cage * c.age);
      console.log("Smoking calc: " + isSmoker * c.smoker);
      console.log("csbp: " + csbp);
      console.log("SBP calc: " + csbp * c.sbp);
      console.log("ctchol: " + ctchol);
      console.log("cTchol calc: " + ctchol_calc);
      console.log("cTchol calc rounded: " + ctchol_rounded);
      console.log("cthdl: " + cthdl);
      console.log("cThdl calc: " + cthdl_calc);
      console.log("cThdl calc rounded: " + cthdl_rounded);
      console.log("smoker_age: " + csmoker_age);
      console.log("smoker_age calc: " + csmoker_age * c.smoker_age);
      console.log("sbp_age calc: " + csbp_age * c.sbp_age);
      console.log("tchol_age calc: " + ctchol_age * c.tchol_age);
      console.log("thdl_age calc: " + cthdl_age * c.thdl_age);
      console.log("basesurv: " + c.basesurv);

      let linearPredictor =
        cage * c.age +
        isSmoker * c.smoker +
        csbp * c.sbp +
        ctchol_rounded +
        cthdl_rounded +
        csmoker_age * c.smoker_age +
        csbp_age * c.sbp_age +
        ctchol_age * c.tchol_age +
        cthdl_age * c.thdl_age;

      console.log("linearPredictor: " + linearPredictor);

      // Calcul du risque à 10 ans non calibré
      let uncalibrated_risk;

      if (age < 70) {
        uncalibrated_risk = 1 - c.basesurv ** Math.exp(linearPredictor);
      } else {
        uncalibrated_risk = 1 - c.basesurv ** Math.exp(Math.abs(linearPredictor) - c.meanLP);
      }

      console.log("uncalibrated: " + uncalibrated_risk);

      // Calibration pays à bas risque
      let calibrated_10y_risk;

      if (age < 70) {
        calibrated_10y_risk =
        1 -
        Math.exp(
          -Math.exp(
            c.scale1 + c.scale2 * Math.log(-Math.log(1 - uncalibrated_risk)),
          ),
        );
      } else {
        // SCORE2 OP for low risk regions
        calibrated_10y_risk =
        1 -
        Math.exp(
          -Math.exp(
            c.scale1 + c.scale2 * Math.log(-Math.log(1 - uncalibrated_risk)),
          ),
        );
      }

      console.log("calibrated: " + calibrated_10y_risk);

      // Conversion en pourcentage
      const riskPercent = (calibrated_10y_risk * 100).toFixed(0);

      displayResult(riskPercent, age);
    }

    function displayResult(risk, age) {
      let category = "";
      let alertClass = "";

      const thresholds = { low: 2, moderate: 10, high: 20 };

      if (risk < thresholds.low) {
        category =
          '<span class="font-weight-bold">Risque cardiovasculaire faible</span> <br> Mesures d’hygiène universelles';
        alertClass = "alert-success";
        if (age < 70) {
          category += '<br> LDL cible &lt; 1,16 g/L';
          // if (LDL >= 1.16) {
          category +=
            ' <hr> Mesures hygiéno-diététiques de réduction du LDL en cas de LDL ≥ 1,16 g/L. <br> Considérer une statine en cas de persistance.';
          //}
        }
      } else if (risk < thresholds.moderate) {
        category =
          '<span class="font-weight-bold">Risque cardiovasculaire modéré</span> <br> Mesures d’hygiène universelles';
        alertClass = "alert-warning";
        if (age < 70) {
          category += '<br> LDL cible &lt; 1 g/L';
          // if (LDL >= 1) {
          category +=
            ' <hr> Mesures hygiéno-diététiques en cas de LDL ≥ 1 g/L. <br> Considérer une statine en cas de persistance.';
          //}
        }
      } else if (risk < thresholds.high) {
        category =
          '<span class="font-weight-bold">Risque cardiovasculaire élevé</span> <br> Mesures d’hygiène universelles';
        alertClass = "alert-danger";
        if (age < 70) {
          category += '<br> LDL cible &lt; 0,7 g/L et réduction ≥ 50 %. <br> Statine d’emblée si LDL ≥ 1 g/L.';
        } else {
          category += '<br> Une statine peut être envisagée chez le sujet en bonne santé. <br> Un objectif &lt; 1 g/L peut sembler raisonnable.';
        }
        /* if (LDL >= 1) {
                        category += '\n Statine d’emblée'
                    } else if (LDL >= 0.7 ) {
                     category += ' <hr> Mesures hygiéno-diététiques en cas de LDL de 0,7 à 0,99 g/L, considérer une statine en cas de persistance'
                    }
                    */
      } else {
        category =
          '<span class="font-weight-bold">Risque cardiovasculaire très élevé</span> <br> Mesures d’hygiène universelles';
        alertClass = "alert-danger";
        if (age < 70) {
          category += '<br> LDL cible &lt; 0,55 g/L et réduction ≥ 50 %. <br> Statine systématique.';
        } else {
          category += '<br> Une statine peut être envisagée chez le sujet en bonne santé. <br> Un objectif &lt; 1 g/L peut sembler raisonnable.';
        }
        /* if (LDL >= 1) {
                        category += '\n Statine d’emblée'
                    } else if (LDL >= 0.7 ) {
                     category += ' <hr> Mesures hygiéno-diététiques en cas de LDL de 0,7 à 0,99 g/L, considérer une statine en cas de persistance'
                    }
                    */
      }

      riskScoreEl.textContent = `${Intl.NumberFormat("fr-FR").format(risk)} %`;
      riskCategoryEl.innerHTML = category;
      riskDescriptionEl.textContent = `Risque de développer une maladie cardiovasculaire fatale ou non fatale dans les 10 prochaines années.`;
      // Mise à jour des classes de l'alerte
      resultDisplay.className = "alert"; // Réinitialiser les classes
      resultDisplay.classList.add(alertClass);

      resultSection.classList.remove("d-none");
    }

    function showError(message) {
      errorMessageEl.textContent = message;
      errorSection.classList.remove("d-none");
    }
  });
</script>
